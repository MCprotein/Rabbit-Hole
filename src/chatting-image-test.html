<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title></title>
</head>
<body>

<hr />
<div id="messages">
<form id="form">
    <input type="text" id="input" autocomplete="off" />
    <button type="submit">Send</button>
</form>

<input type="file" id="my-file" accept="img/jpg, img/gif, img/bmp, img/png"/>
</div>
<hr />

<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">
var socket = io.connect('http://localhost:4000');
var messages = document.getElementById('messages');
var file = document.getElementById('my-file');
form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (input.value) {
      let nickname = socket.id;
      nickname = nickname.substring(1, 5);
      socket.emit('chat message', {name: nickname, msg: input.value});
      input.value = '';
    }
  });

file.addEventListener('change', function () {
if (!file.files.length) {
    return;
    }
var firstFile = file.files[0],
    reader = new FileReader();
        reader.onloadend = function () {
            socket.emit('upload-image', {
            name: firstFile.name,
            data: reader.result,
            type: firstFile.type
            });
        };
reader.readAsArrayBuffer(firstFile);
});


socket.on('connect', function () {
    socket.emit('newUser', socket.id);
    console.log('socket.id : ', socket.id); // x8WIv7-mJelg7on_ALbx
    console.log('client socket.connected: ', socket.connected);
});

socket.on('updateForNewUser', function (msg){
    var item = document.createElement('div');
    item.textContent = msg.message;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
})

socket.on('updateForEveryone', function (msg){
    var item = document.createElement('div');
    item.textContent = msg.message;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
})

socket.on('chat message', function(msg) {
    var item = document.createElement('div');
    item.textContent = msg;
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
  });

socket.on('chat-load', function(message) {
  var item = document.createElement('div');
  item.textContent = message.message;
  messages.appendChild(item);
  window.scrollTo(0, document.body.scrollHeight);
});
socket.on('image-load', function (message) {
    var item = document.createElement('div');
    var img = document.createElement('img');
    img.setAttribute('src', message.image);
    img.setAttribute('alt', "image");
    img.setAttribute('height', '200px');
    img.setAttribute('width', '200px');
    item.appendChild(img);
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
    document.body.appendChild(img);
})
socket.on('image-uploaded', function (message) {
    var arrayBufferView = new Uint8Array(message.data);
    var blob = new Blob( [ arrayBufferView ], { type: message.type } );
    var urlCreator = window.URL || window.webkitURL;
    var imageUrl = urlCreator.createObjectURL( blob );
    var item = document.createElement('div');
    var img = document.createElement('img');
    img.setAttribute('src', imageUrl);
    img.setAttribute('alt', "image");
    img.setAttribute('height', '200px');
    img.setAttribute('width', '200px');
    item.appendChild(img);
    messages.appendChild(item);
    window.scrollTo(0, document.body.scrollHeight);
    document.body.appendChild(img);
        });
</script>
</body>
</html>